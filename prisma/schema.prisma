// =============================================================================
// Dynasty Futures - Prisma Schema
// =============================================================================
// This schema defines the database structure for the Dynasty Futures platform.
// See dynasty-futures-backend-plan.md for entity relationships.
// =============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url = env("DATABASE_URL")
}

// =============================================================================
// ENUMS
// =============================================================================

enum UserRole {
  TRADER
  SUPPORT
  ADMIN
}

enum UserStatus {
  PENDING_VERIFICATION
  ACTIVE
  SUSPENDED
  BANNED
}

enum KycStatus {
  NOT_STARTED
  PENDING
  APPROVED
  REJECTED
}

enum AccountStatus {
  EVALUATION
  PHASE_2
  PASSED
  FUNDED
  SUSPENDED
  FAILED
  CLOSED
}

enum ChallengePhase {
  PHASE_1
  PHASE_2
  FUNDED
}

enum ChallengeStatus {
  ACTIVE
  PASSED
  FAILED
  EXPIRED
}

enum PayoutStatus {
  PENDING
  APPROVED
  PROCESSING
  COMPLETED
  REJECTED
  FAILED
}

enum PayoutMethod {
  BANK_TRANSFER
  STRIPE
  CRYPTO
}

enum ViolationType {
  DAILY_LOSS_LIMIT
  MAX_DRAWDOWN
  POSITION_SIZE
  NEWS_TRADING
  WEEKEND_HOLDING
  CONSISTENCY_RULE
  MINIMUM_TRADING_DAYS
  OTHER
}

enum ViolationSeverity {
  WARNING
  MINOR
  MAJOR
  CRITICAL
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  WAITING_RESPONSE
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

// =============================================================================
// USERS & AUTHENTICATION
// =============================================================================

model User {
  id        String     @id @default(uuid())
  email     String     @unique
  firstName String     @map("first_name")
  lastName  String     @map("last_name")
  phone     String?
  role      UserRole   @default(TRADER)
  status    UserStatus @default(PENDING_VERIFICATION)
  kycStatus KycStatus  @default(NOT_STARTED) @map("kyc_status")

  emailVerified   Boolean   @default(false) @map("email_verified")
  emailVerifiedAt DateTime? @map("email_verified_at")

  lastLoginAt DateTime? @map("last_login_at")
  lastLoginIp String?   @map("last_login_ip")

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  credentials   UserCredential?
  oauthAccounts OAuthAccount[]
  kycDocuments  KycDocument[]
  sessions      Session[]
  accounts      Account[]
  auditLogs     AuditLog[]
  supportTickets SupportTicket[] @relation("TicketCreator")
  assignedTickets SupportTicket[] @relation("TicketAssignee")

  @@index([email])
  @@index([status])
  @@index([role])
  @@index([createdAt])
  @@map("users")
}

model UserCredential {
  id           String    @id @default(uuid())
  userId       String    @unique @map("user_id")
  passwordHash String    @map("password_hash")
  
  // MFA
  mfaEnabled   Boolean   @default(false) @map("mfa_enabled")
  mfaSecret    String?   @map("mfa_secret")
  mfaBackupCodes String[] @map("mfa_backup_codes")
  
  // Password reset
  resetToken       String?   @map("reset_token")
  resetTokenExpiry DateTime? @map("reset_token_expiry")
  
  // Security
  failedAttempts   Int       @default(0) @map("failed_attempts")
  lockedUntil      DateTime? @map("locked_until")
  passwordChangedAt DateTime @default(now()) @map("password_changed_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_credentials")
}

model OAuthAccount {
  id           String @id @default(uuid())
  userId       String @map("user_id")
  provider     String // google, etc.
  providerId   String @map("provider_id")
  accessToken  String? @map("access_token")
  refreshToken String? @map("refresh_token")
  expiresAt    DateTime? @map("expires_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerId])
  @@index([userId])
  @@map("oauth_accounts")
}

model KycDocument {
  id         String    @id @default(uuid())
  userId     String    @map("user_id")
  type       String    // ID_FRONT, ID_BACK, PROOF_OF_ADDRESS, SELFIE
  s3Key      String    @map("s3_key")
  s3Bucket   String    @map("s3_bucket")
  fileName   String    @map("file_name")
  mimeType   String    @map("mime_type")
  status     KycStatus @default(PENDING)
  reviewedBy String?   @map("reviewed_by")
  reviewedAt DateTime? @map("reviewed_at")
  reviewNote String?   @map("review_note")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@map("kyc_documents")
}

model Session {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  expiresAt DateTime @map("expires_at")
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("sessions")
}

// =============================================================================
// ACCOUNTS & CHALLENGES
// =============================================================================

model AccountType {
  id          String @id @default(uuid())
  name        String @unique // "5K", "10K", "25K", etc.
  displayName String @map("display_name")
  description String?
  
  // Account size
  accountSize    Decimal @map("account_size") @db.Decimal(12, 2)
  
  // Challenge pricing
  price          Decimal @db.Decimal(10, 2)
  resetPrice     Decimal @map("reset_price") @db.Decimal(10, 2)
  
  // Profit split
  profitSplit    Int     @map("profit_split") // Percentage (e.g., 80)
  
  // Payout settings
  minPayoutAmount  Decimal @map("min_payout_amount") @db.Decimal(10, 2)
  payoutFrequency  String  @map("payout_frequency") // "bi-weekly", "weekly", "on-demand"

  isActive    Boolean @default(true) @map("is_active")
  sortOrder   Int     @default(0) @map("sort_order")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  accounts       Account[]
  challengeRules ChallengeRule[]

  @@index([isActive])
  @@map("account_types")
}

model ChallengeRule {
  id            String        @id @default(uuid())
  accountTypeId String        @map("account_type_id")
  phase         ChallengePhase

  // Profit target
  profitTarget     Decimal @map("profit_target") @db.Decimal(5, 2) // Percentage
  
  // Drawdown limits
  maxDailyLoss     Decimal @map("max_daily_loss") @db.Decimal(5, 2) // Percentage
  maxTotalDrawdown Decimal @map("max_total_drawdown") @db.Decimal(5, 2) // Percentage
  drawdownType     String  @map("drawdown_type") // "static" or "trailing"

  // Trading requirements
  minTradingDays   Int     @map("min_trading_days")
  maxTradingDays   Int?    @map("max_trading_days") // null = unlimited
  
  // Consistency rules
  consistencyRule       Boolean @default(false) @map("consistency_rule")
  maxSingleDayProfit    Decimal? @map("max_single_day_profit") @db.Decimal(5, 2) // Percentage
  
  // Position sizing
  maxPositionSize       Int?    @map("max_position_size") // Max contracts
  maxOpenPositions      Int?    @map("max_open_positions")
  
  // Time restrictions
  newsRestriction       Boolean @default(true) @map("news_restriction")
  weekendRestriction    Boolean @default(true) @map("weekend_restriction")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  accountType AccountType @relation(fields: [accountTypeId], references: [id])

  @@unique([accountTypeId, phase])
  @@map("challenge_rules")
}

model Account {
  id            String        @id @default(uuid())
  userId        String        @map("user_id")
  accountTypeId String        @map("account_type_id")
  
  // External IDs
  yourPropFirmId String?      @unique @map("your_prop_firm_id")
  
  status        AccountStatus @default(EVALUATION)
  
  // Financial state
  startingBalance Decimal     @map("starting_balance") @db.Decimal(12, 2)
  currentBalance  Decimal     @map("current_balance") @db.Decimal(12, 2)
  highWaterMark   Decimal     @map("high_water_mark") @db.Decimal(12, 2)
  
  // Drawdown tracking
  dailyPnl         Decimal    @default(0) @map("daily_pnl") @db.Decimal(12, 2)
  totalPnl         Decimal    @default(0) @map("total_pnl") @db.Decimal(12, 2)
  currentDrawdown  Decimal    @default(0) @map("current_drawdown") @db.Decimal(5, 2)
  maxDrawdownHit   Decimal    @default(0) @map("max_drawdown_hit") @db.Decimal(5, 2)

  // Trading day tracking
  tradingDays      Int        @default(0) @map("trading_days")
  
  // Timestamps
  activatedAt      DateTime?  @map("activated_at")
  passedAt         DateTime?  @map("passed_at")
  fundedAt         DateTime?  @map("funded_at")
  failedAt         DateTime?  @map("failed_at")
  failedReason     String?    @map("failed_reason")

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  user           User            @relation(fields: [userId], references: [id])
  accountType    AccountType     @relation(fields: [accountTypeId], references: [id])
  challenges     Challenge[]
  trades         Trade[]
  dailySnapshots DailySnapshot[]
  ruleViolations RuleViolation[]
  payouts        Payout[]
  tradingDayLogs TradingDay[]
  adminNotes     AdminNote[]

  @@index([userId])
  @@index([status])
  @@index([accountTypeId])
  @@index([yourPropFirmId])
  @@index([createdAt])
  @@map("accounts")
}

model Challenge {
  id        String          @id @default(uuid())
  accountId String          @map("account_id")
  phase     ChallengePhase
  status    ChallengeStatus @default(ACTIVE)

  // Targets (copied from rules at creation)
  profitTarget     Decimal @map("profit_target") @db.Decimal(5, 2)
  maxDailyLoss     Decimal @map("max_daily_loss") @db.Decimal(5, 2)
  maxTotalDrawdown Decimal @map("max_total_drawdown") @db.Decimal(5, 2)
  minTradingDays   Int     @map("min_trading_days")

  // Progress
  currentProfit    Decimal @default(0) @map("current_profit") @db.Decimal(5, 2)
  tradingDaysCount Int     @default(0) @map("trading_days_count")

  // Stripe
  stripePaymentId String? @map("stripe_payment_id")
  amountPaid      Decimal? @map("amount_paid") @db.Decimal(10, 2)

  startedAt    DateTime  @default(now()) @map("started_at")
  expiresAt    DateTime? @map("expires_at")
  completedAt  DateTime? @map("completed_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  account Account @relation(fields: [accountId], references: [id])

  @@index([accountId])
  @@index([status])
  @@index([phase])
  @@map("challenges")
}

model TradingDay {
  id        String   @id @default(uuid())
  accountId String   @map("account_id")
  date      DateTime @db.Date

  // Daily stats
  startBalance Decimal @map("start_balance") @db.Decimal(12, 2)
  endBalance   Decimal @map("end_balance") @db.Decimal(12, 2)
  pnl          Decimal @db.Decimal(12, 2)
  tradesCount  Int     @map("trades_count")
  
  // Qualified trading day?
  isQualified  Boolean @default(false) @map("is_qualified")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  account Account @relation(fields: [accountId], references: [id])

  @@unique([accountId, date])
  @@index([accountId])
  @@index([date])
  @@map("trading_days")
}

// =============================================================================
// TRADING & RULES
// =============================================================================

model Trade {
  id        String   @id @default(uuid())
  accountId String   @map("account_id")
  
  // External reference
  externalId String? @map("external_id")
  
  // Trade details
  symbol       String
  side         String // BUY, SELL
  quantity     Int
  entryPrice   Decimal  @map("entry_price") @db.Decimal(12, 6)
  exitPrice    Decimal? @map("exit_price") @db.Decimal(12, 6)
  
  // P&L
  realizedPnl  Decimal? @map("realized_pnl") @db.Decimal(12, 2)
  commission   Decimal  @default(0) @db.Decimal(10, 2)
  
  // Timing
  entryTime    DateTime @map("entry_time")
  exitTime     DateTime? @map("exit_time")
  
  // Metadata
  metadata     Json?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  account Account @relation(fields: [accountId], references: [id])

  @@index([accountId])
  @@index([symbol])
  @@index([entryTime])
  @@index([externalId])
  @@map("trades")
}

model DailySnapshot {
  id        String   @id @default(uuid())
  accountId String   @map("account_id")
  date      DateTime @db.Date

  // Balances
  openBalance  Decimal @map("open_balance") @db.Decimal(12, 2)
  closeBalance Decimal @map("close_balance") @db.Decimal(12, 2)
  highBalance  Decimal @map("high_balance") @db.Decimal(12, 2)
  lowBalance   Decimal @map("low_balance") @db.Decimal(12, 2)

  // P&L
  dailyPnl     Decimal @map("daily_pnl") @db.Decimal(12, 2)
  totalPnl     Decimal @map("total_pnl") @db.Decimal(12, 2)

  // Drawdown
  dailyDrawdown    Decimal @map("daily_drawdown") @db.Decimal(5, 2)
  currentDrawdown  Decimal @map("current_drawdown") @db.Decimal(5, 2)

  // Trading activity
  tradesCount      Int @map("trades_count")
  winningTrades    Int @map("winning_trades")
  losingTrades     Int @map("losing_trades")

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  account Account @relation(fields: [accountId], references: [id])

  @@unique([accountId, date])
  @@index([accountId])
  @@index([date])
  @@map("daily_snapshots")
}

model RuleViolation {
  id        String            @id @default(uuid())
  accountId String            @map("account_id")
  type      ViolationType
  severity  ViolationSeverity

  description String
  details     Json?

  // What triggered it
  triggeredValue  Decimal? @map("triggered_value") @db.Decimal(12, 2)
  thresholdValue  Decimal? @map("threshold_value") @db.Decimal(12, 2)

  // Resolution
  acknowledged    Boolean   @default(false)
  acknowledgedBy  String?   @map("acknowledged_by")
  acknowledgedAt  DateTime? @map("acknowledged_at")
  
  // Did it cause account failure?
  causedFailure   Boolean   @default(false) @map("caused_failure")

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  account Account @relation(fields: [accountId], references: [id])

  @@index([accountId])
  @@index([type])
  @@index([severity])
  @@index([createdAt])
  @@map("rule_violations")
}

model NewsEvent {
  id          String   @id @default(uuid())
  title       String
  description String?
  
  // Timing
  eventTime   DateTime @map("event_time")
  
  // Restriction window (trading blocked before/after event)
  restrictionStart DateTime @map("restriction_start")
  restrictionEnd   DateTime @map("restriction_end")
  
  // Impact
  impact      String   // HIGH, MEDIUM, LOW
  currencies  String[] // Affected currencies/instruments

  isActive    Boolean  @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([eventTime])
  @@index([restrictionStart, restrictionEnd])
  @@index([isActive])
  @@map("news_events")
}

// =============================================================================
// PAYOUTS
// =============================================================================

model Payout {
  id        String       @id @default(uuid())
  accountId String       @map("account_id")
  
  amount    Decimal      @db.Decimal(12, 2)
  currency  String       @default("USD")
  status    PayoutStatus @default(PENDING)
  method    PayoutMethod

  // Stripe
  stripeTransferId String? @map("stripe_transfer_id")

  // Bank details (encrypted reference)
  bankDetailsRef   String? @map("bank_details_ref")

  // Approval workflow
  requestedAt DateTime  @default(now()) @map("requested_at")
  reviewedBy  String?   @map("reviewed_by")
  reviewedAt  DateTime? @map("reviewed_at")
  reviewNote  String?   @map("review_note")
  
  processedAt DateTime? @map("processed_at")
  failedAt    DateTime? @map("failed_at")
  failureReason String? @map("failure_reason")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  account Account @relation(fields: [accountId], references: [id])

  @@index([accountId])
  @@index([status])
  @@index([requestedAt])
  @@map("payouts")
}

model PayoutSchedule {
  id        String   @id @default(uuid())
  accountId String   @unique @map("account_id")
  
  // Schedule settings
  frequency  String   // "bi-weekly", "weekly", "monthly"
  dayOfWeek  Int?     @map("day_of_week") // 0-6 for weekly
  dayOfMonth Int?     @map("day_of_month") // 1-31 for monthly
  
  minAmount  Decimal  @map("min_amount") @db.Decimal(10, 2)
  
  isActive   Boolean  @default(true) @map("is_active")
  
  lastPayoutAt DateTime? @map("last_payout_at")
  nextPayoutAt DateTime? @map("next_payout_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("payout_schedules")
}

model TaxDocument {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  year      Int
  type      String   // "1099", "W9", etc.
  
  // Document storage
  s3Key     String   @map("s3_key")
  s3Bucket  String   @map("s3_bucket")
  
  // Totals
  totalPaid Decimal  @map("total_paid") @db.Decimal(12, 2)
  
  generatedAt DateTime @map("generated_at")

  createdAt DateTime @default(now()) @map("created_at")

  @@unique([userId, year, type])
  @@index([userId])
  @@index([year])
  @@map("tax_documents")
}

// =============================================================================
// ADMIN & AUDIT
// =============================================================================

model AuditLog {
  id        String   @id @default(uuid())
  userId    String?  @map("user_id")
  
  action    String   // CREATE_ACCOUNT, APPROVE_PAYOUT, etc.
  entity    String   // User, Account, Payout, etc.
  entityId  String?  @map("entity_id")
  
  // What changed
  oldValues Json?    @map("old_values")
  newValues Json?    @map("new_values")
  
  // Context
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  metadata  Json?

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User? @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([action])
  @@index([entity, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

model SupportTicket {
  id          String         @id @default(uuid())
  creatorId   String         @map("creator_id")
  assigneeId  String?        @map("assignee_id")
  
  subject     String
  description String
  status      TicketStatus   @default(OPEN)
  priority    TicketPriority @default(MEDIUM)
  
  // Related entities
  relatedEntity   String?    @map("related_entity") // Account, Payout, etc.
  relatedEntityId String?    @map("related_entity_id")

  resolvedAt  DateTime?      @map("resolved_at")
  closedAt    DateTime?      @map("closed_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  creator  User  @relation("TicketCreator", fields: [creatorId], references: [id])
  assignee User? @relation("TicketAssignee", fields: [assigneeId], references: [id])

  @@index([creatorId])
  @@index([assigneeId])
  @@index([status])
  @@index([priority])
  @@index([createdAt])
  @@map("support_tickets")
}

model AdminNote {
  id        String @id @default(uuid())
  accountId String @map("account_id")
  authorId  String @map("author_id")
  
  note      String
  isPrivate Boolean @default(true) @map("is_private")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  account Account @relation(fields: [accountId], references: [id])

  @@index([accountId])
  @@index([authorId])
  @@map("admin_notes")
}
