# =============================================================================
# Terraform CI/CD Workflow
# =============================================================================
# This workflow handles Terraform validation, planning, and deployment.
#
# Triggers:
# - On PR: Runs format check, validate, and plan (posts plan to PR comment)
# - On push to main: Runs plan and apply (with manual approval for apply)
#
# TODO: Before this workflow will work:
# 1. Add GitHub secrets (see below)
# 2. Run the backend-setup bootstrap first
# 3. Ensure IAM user has correct permissions
# =============================================================================

name: Terraform

on:
  push:
    branches:
      - main
    paths:
      - 'terraform/**'
      - '.github/workflows/terraform.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'terraform/**'
      - '.github/workflows/terraform.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'prod'
        type: choice
        options:
          - prod
      action:
        description: 'Terraform action to perform'
        required: true
        default: 'plan'
        type: choice
        options:
          - plan
          - apply
          - destroy

# -----------------------------------------------------------------------------
# Environment Variables
# -----------------------------------------------------------------------------

env:
  TF_VERSION: '1.5.7'
  AWS_REGION: 'us-east-1' # TODO: Update if using a different region

# -----------------------------------------------------------------------------
# Permissions
# -----------------------------------------------------------------------------

permissions:
  contents: read
  pull-requests: write
  id-token: write

# -----------------------------------------------------------------------------
# Jobs
# -----------------------------------------------------------------------------

jobs:
  # ---------------------------------------------------------------------------
  # Terraform Format Check
  # ---------------------------------------------------------------------------
  terraform-fmt:
    name: Terraform Format
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Format Check
        id: fmt
        run: terraform fmt -check -recursive
        working-directory: terraform
        continue-on-error: true

      - name: Comment on PR - Format
        if: github.event_name == 'pull_request' && steps.fmt.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '❌ **Terraform Format Check Failed**\n\nPlease run `terraform fmt -recursive` in the terraform directory and commit the changes.'
            })

      - name: Fail if format check failed
        if: steps.fmt.outcome == 'failure'
        run: exit 1

  # ---------------------------------------------------------------------------
  # Terraform Validate
  # ---------------------------------------------------------------------------
  terraform-validate:
    name: Terraform Validate
    runs-on: ubuntu-latest
    needs: terraform-fmt

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init (Validate Only)
        run: terraform init -backend=false
        working-directory: terraform/environments/prod

      - name: Terraform Validate
        id: validate
        run: terraform validate
        working-directory: terraform/environments/prod

  # ---------------------------------------------------------------------------
  # Terraform Plan
  # ---------------------------------------------------------------------------
  terraform-plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    needs: terraform-validate
    if: github.event_name == 'pull_request' || github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && (github.event.inputs.action == 'plan' || github.event.inputs.action == 'apply'))

    # TODO: Add these secrets to your GitHub repository:
    # - AWS_ACCESS_KEY_ID: IAM user access key
    # - AWS_SECRET_ACCESS_KEY: IAM user secret key
    # - TF_VAR_stripe_secret_key: Stripe secret API key (sk_live_...)
    # - TF_VAR_stripe_webhook_secret: Stripe webhook signing secret (whsec_...)
    # - TF_VAR_stripe_publishable_key: Stripe publishable key (pk_live_...)
    # - TF_VAR_google_client_id: Google OAuth client ID
    # - TF_VAR_google_client_secret: Google OAuth client secret
    #
    # Go to: Repository Settings -> Secrets and variables -> Actions -> New repository secret

    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      TF_VAR_stripe_secret_key: ${{ secrets.TF_VAR_STRIPE_SECRET_KEY }}
      TF_VAR_stripe_webhook_secret: ${{ secrets.TF_VAR_STRIPE_WEBHOOK_SECRET }}
      TF_VAR_stripe_publishable_key: ${{ secrets.TF_VAR_STRIPE_PUBLISHABLE_KEY }}
      TF_VAR_google_client_id: ${{ secrets.TF_VAR_GOOGLE_CLIENT_ID }}
      TF_VAR_google_client_secret: ${{ secrets.TF_VAR_GOOGLE_CLIENT_SECRET }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init
        id: init
        run: terraform init
        working-directory: terraform/environments/prod

      - name: Terraform Plan
        id: plan
        run: |
          terraform plan -out=tfplan -detailed-exitcode 2>&1 | tee plan_output.txt
          echo "exitcode=${PIPESTATUS[0]}" >> $GITHUB_OUTPUT
        working-directory: terraform/environments/prod
        continue-on-error: true

      - name: Upload Plan
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan
          path: terraform/environments/prod/tfplan
          retention-days: 5

      - name: Comment on PR - Plan
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const planOutput = fs.readFileSync('terraform/environments/prod/plan_output.txt', 'utf8');

            // Truncate if too long
            const maxLength = 60000;
            const truncatedOutput = planOutput.length > maxLength 
              ? planOutput.substring(0, maxLength) + '\n\n... (truncated)'
              : planOutput;

            const exitCode = '${{ steps.plan.outputs.exitcode }}';
            let summary = '';
            if (exitCode === '0') {
              summary = '✅ **No changes** - Infrastructure is up to date';
            } else if (exitCode === '2') {
              summary = '⚠️ **Changes detected** - Review the plan below';
            } else {
              summary = '❌ **Plan failed** - See output below';
            }

            const body = `## Terraform Plan Results

            ${summary}

            <details>
            <summary>Show Plan Output</summary>

            \`\`\`hcl
            ${truncatedOutput}
            \`\`\`

            </details>

            *Pushed by: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            })

      - name: Plan Status
        if: steps.plan.outputs.exitcode == '1'
        run: exit 1

  # ---------------------------------------------------------------------------
  # Terraform Apply (Manual Trigger Only)
  # ---------------------------------------------------------------------------
  terraform-apply:
    name: Terraform Apply
    runs-on: ubuntu-latest
    needs: terraform-plan
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'apply'
    environment: production # TODO: Create this environment in GitHub for manual approval

    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      TF_VAR_stripe_secret_key: ${{ secrets.TF_VAR_STRIPE_SECRET_KEY }}
      TF_VAR_stripe_webhook_secret: ${{ secrets.TF_VAR_STRIPE_WEBHOOK_SECRET }}
      TF_VAR_stripe_publishable_key: ${{ secrets.TF_VAR_STRIPE_PUBLISHABLE_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Download Plan
        uses: actions/download-artifact@v4
        with:
          name: terraform-plan
          path: terraform/environments/prod

      - name: Terraform Init
        run: terraform init
        working-directory: terraform/environments/prod

      - name: Terraform Apply
        run: terraform apply -auto-approve tfplan
        working-directory: terraform/environments/prod

      - name: Output Summary
        run: |
          echo "## Terraform Apply Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Environment: ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "Applied by: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          terraform output >> $GITHUB_STEP_SUMMARY
        working-directory: terraform/environments/prod

  # ---------------------------------------------------------------------------
  # Terraform Destroy (Manual Trigger Only - USE WITH CAUTION)
  # ---------------------------------------------------------------------------
  terraform-destroy:
    name: Terraform Destroy
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'destroy'
    environment: production-destroy # TODO: Create this environment with required reviewers

    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      TF_VAR_stripe_secret_key: ${{ secrets.TF_VAR_STRIPE_SECRET_KEY }}
      TF_VAR_stripe_webhook_secret: ${{ secrets.TF_VAR_STRIPE_WEBHOOK_SECRET }}
      TF_VAR_stripe_publishable_key: ${{ secrets.TF_VAR_STRIPE_PUBLISHABLE_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init
        run: terraform init
        working-directory: terraform/environments/prod

      - name: Terraform Destroy
        run: terraform destroy -auto-approve
        working-directory: terraform/environments/prod
